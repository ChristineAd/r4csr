# (PART) Clinical Trial Project {-}

# Overview

In a late-stage clinical trial, the number of A&R deliverables can easily be in the hundreds. 
For an organization, it is also common to have multiple ongoing clinical trials in a clinical program. 

To deliver A&R results of a clincial tiral project, it is a team work that typically require
collaborations from both statisticians and programmers. 
In this part, let's consider how to organize a clinical trial project as an A&R leader. 

In Chapter \@ref(folder), we will discuss how to organize source code, documents, 
deliverables in an A&R clinical project. 
We recommend to use the R package folder structure. 

In Chapter \@ref(manage), we will discuss a process or system development lifecycle 
to manage A&R of a clinical project. 
We recommend to follow an agile management approach to define, develop, validate and deliver work.

# Project Folder {#folder}

A clearly defined clinical project folder structure can have many benefits to 
clinical development teams in an organization. 
Specifically a well defined project folder can achieve:

- Consistency: every team work on the same folder structure.
- Reproducibility: analysis can be executed and reproduced by different team members months/years later.  
- Automation: automatically check integration of a project.  
- Compliance: reduce compliance issue

We illustrate the R package project folder for A&R project using a demo project called 
[`esubdemo`](https://github.com/elong0527/esubdemo.git). You can [clone](https://happygitwithr.com/rstudio-git-github.html#clone-the-new-github-repository-to-your-computer-via-rstudio) 
the project using RStudio. 

## Consistency 

For consistency, a well defined folder structure with potential templates
ensures project teams organize A&R work consistently across multiple projects. 
Consistent folder structure also reduce communication cost between study team members 
and enhances the transparency of projects.

For R user, you already benefit from a well defined and consistent folder structure. 
That is the [R package folder structure](https://github.com/rstudio/cheatsheets/raw/master/package-development.pdf). 
Every R package developer is required to follow the same convention to organize their R
functions, before the R package can be disseminated through the Comprehensive R Archive Network
(CRAN). As a user, you can easily install and use those R packages after installing from CRAN. 
There are many good resources to guide developers on R package development.
For example, [Hadley Wickmans' R packages book](https://r-pkgs.org/)

We recommend to use R package folder structure to organize analysis scripts 
for clinical trial development. 
Using the R package folder structure to streamline data analysis work has also been proposed before 
(@marwick2018packaging, @wuanalysis). 

In this book, we refer an R package as **project specific R package**. 
The purpose of project specific R package is to organize analysis scripts for a clinical project.
We refer an R package as **standard R package** if the purpose of an R package is to 
share commonly used R functions to be hosted in an code repository such as CRAN. 

Below is a minimal sufficient folders and files based on the R package folder structure.  

- `*.Rproj`: RStudio project file used to open RStudio project.
- `DESCRIPTION`: Metadata for a package including authors, license, dependency etc.
- `R/`: Project specific R functions.
- `vignettes/`: Analysis scripts using Rmarkdown.
- `man/`: Manual of project specific R functions.

To illustrate the idea, you can open `esubdemo` project by click the `esubdemo.Rproj` project. 

For analysis code to create TLFs, we saved them in the `vignettes/` folder. 
In `esubdemo`, we put analysis code we learned from previous chapters into the `vignettes` folder.

> Here the `adam\` folder contain ADaM datasets. 
> The `tlf` folder contain output TLFs in RTF format.
> We put `adam\` and `tlf\` folder within `vignettes` folder only for illustration purpose. 
> In a real A&R report, you may have different location to save your input and output.

```
vignettes
├── adam_data
├── tlf
├── tlf-01-disposition.Rmd
├── tlf-02-population.Rmd
├── tlf-03-baseline.Rmd
├── tlf-04-efficacy.Rmd
├── tlf-05-ae-summary.Rmd
└── tlf-06-ae-spec.Rmd
```

In previous chapters, we also create a few helper functions that can be used for different analysis. 
(e.g. `fmt_num` and `count_by`). 
We put those helper functions into the `R/` folder. 

> Here `zzz.R` is a template file that ensure startup file `inst/startup.R` is executed. 
> We will revisit startup file while we discuss reproducibility. 

```
R
├── count_by.R
├── fmt.R
└── zzz.R
```

The `man` folder is used to save documentation automatically generated by `roxygen2`.
A typical workflow is to add `roxygen2` documentations at the header of each function in the `R\` folder. 
Then `devtools::documents()` is used to generate all the documentation files in the `man\` folder. 
More details can be found in [Chapter 10 of the R packages book](https://r-pkgs.org/man.html). 

## Reproducibility {#reproduce}

Reproducibility of analysis can be challenge. 
By using R package folder structure and proper tools (e.g. `renv`, `packrat`), 
we illustrate how to achieve reproducibility for R and R package versions. 

> This is the same level of reproducibility in most SAS environment.
> https://support.sas.com/techsup/pcn/altopsys.html

In `esubdemo` project, a reproducible environment is created when you open the 
`esubdemo.Rproj` from RStudio. 
While RStudio open `esubdemo` project, RStudio will automatically execute R code in `.Rprofile`.
So we can use `.Rprofile` to setup a reproducible environment. 
More details can be found in [https://rstats.wtf/r-startup.html](https://rstats.wtf/r-startup.html). 

> `.Rprofile` is only for project specific R package. 
> A standard R package should not use `.Rprofile`.   

In `esubdemo`, the `.Rprofile` contain two lines of R code. 

```{r}
source("inst/startup.R")
source("renv/activate.R")
```

The first line execute R code saved in `inst/startup.R`. 
People can define a customized startup file to check running environment. 

For example, we can require R version to be `4.1.1` by using code below. 
```{r, eval = FALSE}
R_version <- "4.1.1"	# set up project R version

# Check R Version
if(paste(R.version$major, R.version$minor, sep = ".") != R_version){
 warning("The current R version is not the same with the current project in ", R_version)
}
```

If the R version mismatch, an error message is displayed as below.

```
Error: The current R version is not the same as the current project in R4.1.1
```

We can also define the package repository to be a specific snapshot date.
For example, we used Microsoft R Application Network (MRAN) to define the snapshot date to be `2021-08-06`. 
The snapshot date freeze the R package repository. 
In other words, all R packages installed in this RStudio project 
are based on the frozen R version at the snapshot date. 
Here it is `2021-08-06` by using MRAN server. 

```{r}
# set up snapshot date
snapshot  <- "2021-08-06" 	

# set up repository based on snapshot
repos     <- paste0("https://mran.microsoft.com/snapshot/", snapshot)  

# Define repo URL for project specific package installation
options(repos = repos)
```

> RStudio Package Manager (RSPM) provided a solution to host both 
> public avaiable and internally developed R packages. 
> However, public RSPM server (https://packagemanager.rstudio.com/client/#/repos/2/overview) 
> did not provide daily snapshot as MRAN had. 

The second line execute R code in `renv/activate.R`. 
This is a default behavior by using the `renv` R package to manage snapshot 
of the R packages. 
The `renv` provide a robust and stable approach to manage R package version 
for a project specific R packages.
As a user, you can use `renv::init()`, `renv::snapshot()` and `renv::restore()` 
to initialize, save and restore R packages used for the current analysis project. 

In the analysis project, the `renv` package will 

- create a `renv.lock` file to save the state of package versions.
- create a `renv` folder to manage R packages for a project. 

An introduction of `renv` can be found in its [package website](https://rstudio.github.io/renv/articles/renv.html).

> `renv.lock` file and `renv/` folder are only for project specific R package. 
> A standard R package should not use `renv`.  

In summary, the R package version is controlled in two layers. 

- Define a snapshot date in `inst/startup.R`.
- Using `renv` to lock R versions within a project. 

If the project is initiated properly  
you shall be able to see similar messages to inform how we control R package versions. 

```
* Project '~/esubdemo' loaded. [renv 0.14.0]
Current oroject R package repository:
    https://mran.microsoft.com/snapshot/2021-08-06
```

Once R packages have been properly installed, 
the system will use the R packages located in the search 
path defined based on the order of `.libPaths()`.
The startup message also provided the R package search path. 

```
Below R package path are searching in order to find installed R pacakges in this R session:
    /home/esubdemo/renv/library/R-4.0/x86_64-pc-linux-gnu
    /rtmp/Rtmp8d5mcL/renv-system-library
```

> A cloud based R environment (e.g. RStudio Workbench) 
> can enhance the reproducibility within an organization 
> by using the same operation system, R and R package versions for an A&R project. 
> More details can be found in [https://environments.rstudio.com/](https://environments.rstudio.com/).   

> A container like [docker](https://github.com/rstudio/r-docker) can further enhance 
> the reproducibility across an organization at operation system level, but beyond the scope of this book. 

In conclusion, to achieve reproducibility for a project specific R package, 
a clinical project team can work under a controlled R environment 
in the same R version and R package versions defined by a repository snapshot date.

## Automation 

By using the R package folder structure, you will benefit from many outstanding tools to 
simplify and streamline your workflow. 

Here is a short list of commonly used R packages 

- [`devtools`](https://devtools.r-lib.org/): make package development easier. 
  + A good overview can be found in [Chapter 2 of the R packages](https://r-pkgs.org/whole-game.html) book  
- [`usethis`](https://usethis.r-lib.org/): automates repetitive tasks that arise during project setup and development.
- [`testthat`](https://testthat.r-lib.org/): streamline testing code.
  + A discussion of using the `testthat` for an A&R project can be found in (@madhutest).  
- [`pkgdown`](https://pkgdown.r-lib.org/): generate static html documentation for an R package
  + It also allow you to run all analysis code in batch. 

## Compliance

- ToDo
