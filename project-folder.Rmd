# (PART) Clinical Trial Project {-}

# Overview

In a late-stage clinical trial, the number of A&R deliverables can easily be in the hundreds. 
For an organization, it is also common to have multiple ongoing clinical trials in a clinical program. 

In this part, we would like to put you as an A&R leader for a clinical project. 

In Chapter \@ref(folder), we will discuss how to organize source code, documents, 
deliverables in an A&R clinical project. 
We recommend to use the R package folder structure. 

In Chapter \@ref(manage), we will discuss a process or system development lifecycle 
to manage A&R of a clinical project. 
We recommend to follow an agile management approach to define, develop, validate and deliver work.

# Project Folder {#folder}

A clearly defined project folder structure can have many benefits to 
clinical development teams in an organization. 
Specifically a well defined project folder can achieve:

- Consistency
- Reproducibility
- Automation
- Compliance

For R users, you already benefit from a well defined and consistent folder structure. 
That is the R package folder structure. 
Every R package developer is required to follow the same convention to organize their R
functions, before the package can be disseminated through the Comprehensive R Archive Network
(CRAN). As a user, you can easily install and use those packages after installing from CRAN. 
With a mature folder structure, you also get strong support from the community. 

We recommend to also use R package folder structure to organize analysis scripts 
for clinical trial development. 
Using the R package folder structure to streamline data analysis work has been proposed 
(@marwick2018packaging, @wuanalysis). 



## Consistency 

For consistency, a well defined folder structure with potential templates
ensures project teams organize A&R work consistently across multiple projects. 
Consistent folder structure also reduce communication cost between study team members 
and enhances the transparency of projects.

In this book, we refer an R package as **project specific R package** 
if the purpose of an R package is to organize analysis scripts for a clinical project.
We refer an R package as **standard R package** if the purpose of an R package is to 
share commonly used R functions to be hosted in an code repository such as CRAN. 

Below is a minimal sufficient folders and files for a project specific R package
based on the R package folder structure.  

- `*.Rproj`: RStudio project file used to open RStudio project.
- `DESCRIPTION`: Metadata for a package including authors, license, dependency etc.
- `vignettes/`: Analysis scripts using Rmarkdown.
- `R/`: Project specific R functions.
- `man/`: Manual of project specific R functions.

A general discussion of the R package folder structure can be found 
in Chapter 4 of the R package book (@wickham2015r).

We demonstrate the idea using the [`esubdemo`](https://github.com/elong0527/esubdemo) project.

In `esubdemo` project, we saved all TLF generation scripts in previous chapters into the `vignettes/` folder. 

```
vignettes/
├── tlf-01-disposition.Rmd
├── tlf-02-population.Rmd
├── tlf-03-baseline.Rmd
├── tlf-04-efficacy.Rmd
├── tlf-05-ae-summary.Rmd
└── tlf-06-ae-spec.Rmd
```

While creating those analysis scripts, we also defined a few helper functions. 
Those functions are saved in the `R/` folder. 

```
R/
├── count_by.R
└── fmt.R
```

With a formal project, it is also important to provide proper documentations for 
those help functions. We used `Roxygen2` to document functions. 
For example, the header below provide the definition of each variable in `fmt_est`. 
More details can be found in [Chpater 10 of the R package book](https://r-pkgs.org/man.html)

```{r, eval = FALSE}
#' Format point estimator
#'
#' @param .mean mean of an estimator.
#' @param .sd sd of an estimator.
#' @param digits number of digits for `.mean` and `.sd`.
#'
#' @export
fmt_est <- function(.mean,
                    .sd,
                    digits = c(1, 2)) {
  .mean <- fmt_num(.mean, digits[1], width = digits[1] + 4)
  .sd <- fmt_num(.sd, digits[2], width = digits[2] + 3)
  paste0(.mean, " (", .sd, ")")
}
```

Those `Roxygen2` documentation will be transferred to 
standard R documentation `.Rd` files saved in the `man/` folder. 
This step is automatically handled by `devtools::document()` function.

```
man
├── count_by.Rd
├── fmt_ci.Rd
├── fmt_est.Rd
├── fmt_num.Rd
└── fmt_pval.Rd
```

## Reproducibility {#reproduce}

Reproducibility of analysis is one of the most important aspects for regulatory deliverables. 
By using R package folder structure and proper tools (e.g. `renv`, `packrat`), 
we can easily achieve reproducibility for R and R package versions. 

> This is the same level of reproducibility in most SAS environment.
> https://support.sas.com/techsup/pcn/altopsys.html

In `esubdemo` project, a reproducible environment is created when you open the 
`esubdemo.Rproj` from RStudio. 
While RStudio open `esubdemo` project, RStudio will automatically execute R code in `.Rprofile`.
So we are using `.Rprofile` to setup a reproducible environment. 
More details can be found in [https://rstats.wtf/r-startup.html](https://rstats.wtf/r-startup.html). 

> `.Rprofile` is only for project specific R package. 
> A standard R package should not use `.Rprofile`.   

After we open the `esubdemo` project, the code in `.Rprofile` will automatically check 
current R version is the same as we defined in `.Rprofile` 

```{r, eval = FALSE}
R_version <- "4.1.1" # set up project R version
```

If the R version mismatch, an error message is displayed as below.

```
Error: The current R version is not the same as the current project in R4.1.1
```

If we are running under the same R version, 
you shall be able to see similar messages to inform how we control R package version. 

```
Current oroject R package repository:
    https://mran.microsoft.com/snapshot/2021-08-06
```

The R package version is controlled in two layers. 
Firstly, we define a snapshot date in `.Rprofile`. 
The snapshot date allows us to freeze the source code repository. 
In other words, all R packages installed in this RStudio project 
are based on the frozen R version at the snapshot date. 
Here it is `2021-08-06` by using Microsoft R Application Network (MRAN) server. 

```{r, eval = FALSE}
snapshot <- "2021-08-06" # set up snapshot date
repos <- paste0("https://mran.microsoft.com/snapshot/", snapshot) # set up repository based on snapshot
```

> RStudio Package Manager (RSPM) provided a solution to host both 
> public avaiable and internally developed R packages. 
> However, public RSPM server (https://packagemanager.rstudio.com/client/#/repos/2/overview) 
> did not provide daily snapshot as MRAN had. 

Secondly, we use `renv` to lock R package versions and saved in `renv.lock` file. 
The exact same R package versions can be restored with `renv::restore()`.
An introduction of `renv` can be found in its 
[package website](https://rstudio.github.io/renv/articles/renv.html).

```
* Project '~/github-repo/esubdemo' loaded. [renv 0.14.0]
```

> `renv.lock` file and `renv/` folder are only for project specific R package. 
> A standard R package should not use `renv`.   

Once R packages have been properly installed, 
the system will use the R packages located in the search path defined based on the order of `.libPaths()`.
The startup message also provided the R package search path. 

```
Below R package path are searching in order to find installed R pacakges in this R session:
    "/home/zhanyilo/github-repo/esubdemo/renv/library/R-4.1/x86_64-pc-linux-gnu"
    "/rtmp/RtmpT3ljoY/renv-system-library"   
```

For an organization, a cloud based R environment (e.g. RStudio Workbench) 
can further enhance the reproducibility of clinical projects by 
centralize managing operation system, R and R package version. 
More details can be found in [https://environments.rstudio.com/](https://environments.rstudio.com/).   

In summary, to achieve reproducibility for a project specific R package, 
a clinical project team can work under a controlled R environment 
in the same R version and R package versions defined by a repository snapshot date.

## Automation 

By using the R package folder structure for analysis and reporting clinical projects,
there are many tools that can help project team simplify the workflow. 

We have learned a few functions in `devtools` to automatically generate content. 
Here is a short list of tools that can enhance the workflow. 

- `devttols::load_all()`: load all functions in `R/` folder and running environment. 
- `devtools::document()`: automatically create documentation using `Roxygen2`
- `devttols::check()`: automatically perform compliance check as an R package. 
- `devtools::build_site()`: automatically run analysis scripts in batch and create a `pkgdown` website. 
- `usethis` package: automatically project and template setup.
- `testthat` package: automatically execute validation code. 

You may further automatically execute routines by leveraging CI/CD workflow. 
For example, the `esubdemo` project will rerun all required check and build pkgdown website
by using [github action](https://usethis.r-lib.org/reference/github_actions.html).

As the consistent folder is defined, it also become easier to create specific tools 
that fit for the analysis and reporting purpose. 

Below are few potential tools that can be helpful:

- Create project template using [RStudio Project Templates](https://rstudio.github.io/rstudio-extensions/rstudio_project_templates.html)
- Add additional compliance check for analysis and reporting. 
- Save log files for running in batch. 

## Compliance

For a regulatory deliverable, it is important to maintain compliance. 
With a consistent folder structure, we can define specific criteria for compliance. 
Some compliance criteria can be implemented within the automatically checking steps. 

For an R package, there are already criteria to ensure R package integrity.  
More details can be found in [Chapter 19 of the R package book](https://r-pkgs.org/r-cmd-check.html).

